<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray */
            color: #f3f4f6; /* Light Gray */
        }
        .card {
            background-color: #1f2937; /* Gray-800 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-insight-list li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .ai-insight-list li::before {
            content: 'âœ¨';
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="loader-container" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex justify-center items-center z-50">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-semibold text-white">Analyzing Your Data...</p>
            <p class="text-sm text-gray-400">Fetching spreadsheets and generating insights.</p>
        </div>
    </div>

    <div id="dashboard-content" class="opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Project Dashboard</h1>
            <p class="text-gray-400 mt-1">Real-time analysis from your team's data.</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- AI Insights Card -->
            <div class="card md:col-span-2 lg:col-span-4">
                <h2 class="text-xl font-semibold text-white mb-4">AI-Generated Insights</h2>
                <div id="ai-insights-content">
                    <p class="text-gray-400">Generating summary...</p>
                </div>
            </div>

            <!-- Target vs Actual Card -->
            <div class="card md:col-span-2">
                <h2 class="text-xl font-semibold text-white mb-4">Target vs. Actual</h2>
                <div class="h-64"><canvas id="targetVsActualChart"></canvas></div>
            </div>

            <!-- Performance Card -->
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4">Performance Score</h2>
                <div class="h-64"><canvas id="performanceChart"></canvas></div>
            </div>

            <!-- Manpower Card -->
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4">Manpower Status</h2>
                <div class="h-64 flex flex-col justify-center items-center">
                    <div id="manpower-total" class="text-6xl font-bold text-blue-400">0</div>
                    <p class="text-gray-400 mt-2">Total Team Members</p>
                </div>
            </div>

            <!-- Attendance Card -->
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4">Attendance</h2>
                <div class="h-64"><canvas id="attendanceChart"></canvas></div>
            </div>
            
            <!-- Overall Status Card -->
            <div class="card md:col-span-2">
                 <h2 class="text-xl font-semibold text-white mb-4">Overall Status</h2>
                 <div class="h-64"><canvas id="overallChart"></canvas></div>
            </div>

            <!-- Work Entries Table Card -->
            <div class="card md:col-span-2 lg:col-span-4">
                <h2 class="text-xl font-semibold text-white mb-4">Recent Work Entries</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3">Date</th>
                                <th scope="col" class="px-4 py-3">Name</th>
                                <th scope="col" class="px-4 py-3">Project</th>
                                <th scope="col" class="px-4 py-3">Task</th>
                            </tr>
                        </thead>
                        <tbody id="work-entries-table">
                           <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loaderContainer = document.getElementById('loader-container');
            const dashboardContent = document.getElementById('dashboard-content');

            const sheetUrls = {
                workEntries: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=675931107&single=true&output=csv',
                attendance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1025965600&single=true&output=csv',
                allOver: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1615191290&single=true&output=csv',
                performance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1486071949&single=true&output=csv',
                manpower: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1764212547&single=true&output=csv',
                targetVsActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1275238181&single=true&output=csv'
            };

            // --- DATA FETCHING AND PARSING ---
            
            // Fetches and parses CSV data from a URL
            const fetchCsvData = async (url) => {
                try {
                    // Using another CORS proxy.
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    console.error('Error fetching data for:', url, error);
                    // Display error message to user
                    const errorCard = document.createElement('div');
                    errorCard.className = 'card bg-red-900 text-white md:col-span-2 lg:col-span-4';
                    errorCard.innerHTML = `<h2 class="font-bold">Data Fetch Error</h2><p>Could not load data from a spreadsheet. This might be due to network issues or the public CORS proxy being temporarily unavailable.</p><p class="text-sm mt-2">URL: ${url}</p><p class="text-sm mt-1">Error: ${error.message}</p>`;
                    // Prepend error to the main grid
                    dashboardContent.querySelector('.grid').prepend(errorCard);
                    return []; // Return empty array to prevent further errors
                }
            };
            
            // Simple CSV parser
            const parseCSV = (text) => {
                const lines = text.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return header.reduce((obj, nextKey, index) => {
                        obj[nextKey] = values[index] ? values[index].trim() : '';
                        return obj;
                    }, {});
                });
            };

            // Fetch all data concurrently
            const [
                workEntriesData,
                attendanceData,
                allOverData,
                performanceData,
                manpowerData,
                targetVsActualData
            ] = await Promise.all([
                fetchCsvData(sheetUrls.workEntries),
                fetchCsvData(sheetUrls.attendance),
                fetchCsvData(sheetUrls.allOver),
                fetchCsvData(sheetUrls.performance),
                fetchCsvData(sheetUrls.manpower),
                fetchCsvData(sheetUrls.targetVsActual)
            ]);

            // --- CHART RENDERING ---

            // 1. Target vs Actual Chart
            if (targetVsActualData.length > 0) {
                const targetCtx = document.getElementById('targetVsActualChart').getContext('2d');
                new Chart(targetCtx, {
                    type: 'bar',
                    data: {
                        labels: targetVsActualData.map(d => d.Month),
                        datasets: [{
                            label: 'Actual',
                            data: targetVsActualData.map(d => parseFloat(d.Actual)),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Target',
                            data: targetVsActualData.map(d => parseFloat(d.Target)),
                            backgroundColor: 'rgba(249, 115, 22, 0.7)',
                            borderColor: 'rgba(249, 115, 22, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            // 2. Performance Chart
            if (performanceData.length > 0) {
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                new Chart(performanceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: performanceData.map(d => d.Category),
                        datasets: [{
                            label: 'Performance Score',
                            data: performanceData.map(d => parseInt(d.Score)),
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(239, 68, 68, 0.7)',
                                'rgba(245, 158, 11, 0.7)'
                            ],
                            borderColor: ['#10B981', '#EF4444', '#F59E0B'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // 3. Manpower Display
            if (manpowerData.length > 0) {
                document.getElementById('manpower-total').textContent = manpowerData.length;
            }

            // 4. Attendance Chart
            if (attendanceData.length > 0) {
                const presentCount = attendanceData.filter(d => d.Status.toLowerCase() === 'present').length;
                const absentCount = attendanceData.length - presentCount;
                const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
                new Chart(attendanceCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Present', 'Absent'],
                        datasets: [{
                            data: [presentCount, absentCount],
                            backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                            borderColor: ['#22C55E', '#EF4444'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // 5. Overall Status Chart
            if (allOverData.length > 0) {
                const overallCtx = document.getElementById('overallChart').getContext('2d');
                new Chart(overallCtx, {
                    type: 'radar',
                    data: {
                        labels: allOverData.map(d => d.Metric),
                        datasets: [{
                            label: 'Status (%)',
                            data: allOverData.map(d => parseInt(d.Value)),
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: 'rgb(99, 102, 241)',
                            pointBackgroundColor: 'rgb(99, 102, 241)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(99, 102, 241)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // 6. Work Entries Table
            if (workEntriesData.length > 0) {
                const tableBody = document.getElementById('work-entries-table');
                tableBody.innerHTML = ''; // Clear previous entries
                // Show latest 5 entries
                workEntriesData.slice(0, 5).forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-800 border-b border-gray-700';
                    row.innerHTML = `
                        <td class="px-4 py-3">${entry.Date || 'N/A'}</td>
                        <td class="px-4 py-3 font-medium text-white">${entry.Name || 'N/A'}</td>
                        <td class="px-4 py-3">${entry.Project || 'N/A'}</td>
                        <td class="px-4 py-3">${entry.Task || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // --- AI INSIGHTS GENERATION ---
            
            const generateAIInsights = async () => {
                const aiContainer = document.getElementById('ai-insights-content');
                const prompt = `
                    Analyze the following project data and provide a bulleted list of key insights. Be concise and focus on actionable information.
                    - Summarize the overall performance based on Target vs Actual.
                    - Highlight any notable attendance patterns.
                    - Mention the overall manpower count.
                    - Point out the best and worst performing categories from the performance data.
                    - Give a conclusion on the project's health.

                    Data:
                    Target vs Actual: ${JSON.stringify(targetVsActualData)}
                    Attendance: ${attendanceData.length} total records, with ${attendanceData.filter(d => d.Status.toLowerCase() === 'present').length} present.
                    Performance: ${JSON.stringify(performanceData)}
                    Manpower: ${manpowerData.length} team members.
                `;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key will be injected by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                        const text = result.candidates[0].content.parts[0].text;
                        // Format the text into a nice list
                        const insightsHtml = '<ul class="ai-insight-list space-y-3 text-gray-300">' + 
                            text.split('\n').filter(line => line.trim().startsWith('*') || line.trim().startsWith('-'))
                            .map(line => `<li>${line.substring(1).trim()}</li>`).join('') + '</ul>';
                        aiContainer.innerHTML = insightsHtml;
                    } else {
                        throw new Error("No content received from AI.");
                    }
                } catch (error) {
                    console.error("Error generating AI insights:", error);
                    aiContainer.innerHTML = `<p class="text-red-400">Could not generate AI insights. ${error.message}</p>`;
                }
            };
            
            await generateAIInsights();

            // Hide loader and show content
            loaderContainer.style.display = 'none';
            dashboardContent.style.opacity = 1;

        });
    </script>
</body>
</html>
