<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Dashboard</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            color: #333;
            line-height: 1.6;
            padding: 15px;
        }

        /* Header with corporate styling */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Loading spinner with corporate colors */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Section headers with corporate accent */
        .section-header {
            font-size: 1.6rem;
            color: #2c3e50;
            margin: 35px 0 25px 0;
            padding: 15px 0;
            border-bottom: 3px solid #667eea;
            position: relative;
        }

        .section-header::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: #764ba2;
        }

        /* Responsive card grid layouts */
        .cards-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 40px;
        }

        /* Performance cards - responsive grid */
        .performance-grid {
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .performance-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .performance-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Attendance cards - responsive grid */
        .attendance-grid {
            grid-template-columns: 1fr;
        }

        @media (min-width: 900px) {
            .attendance-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Overview cards - responsive grid */
        .overview-grid {
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Enhanced card styles with corporate design */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f8f9fa;
            display: flex;
            align-items: center;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 12px;
            border-radius: 2px;
        }

        /* Performance card specific styles */
        .performance-card .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .performance-card .metric:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .metric-value {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .productivity-value {
            color: #27ae60;
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* Enhanced attendance card styles */
        .attendance-card {
            min-height: 300px;
        }

        .worker-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .attendance-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .day-header {
            text-align: center;
            font-weight: 700;
            color: #667eea;
            font-size: 0.85rem;
            padding: 10px 4px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 45px;
        }

        .day-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        /* Enhanced attendance status colors */
        .present {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        .overtime {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
        }

        .absent {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .no-data {
            background: #ecf0f1;
            color: #95a5a6;
            border: 2px dashed #bdc3c7;
        }

        .overtime-hours {
            font-size: 0.7rem;
            margin-top: 2px;
            opacity: 0.9;
        }

        /* Enhanced overview card styles */
        .overview-card .date-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .overview-card .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .overview-card .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .achievement-percentage {
            font-size: 1.3rem;
            font-weight: 800;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
        }

        .achievement-high {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .achievement-medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .achievement-low {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .section-header {
                font-size: 1.4rem;
            }
            
            .card-title {
                font-size: 1.2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .day-cell {
                min-height: 40px;
                font-size: 0.75rem;
            }
        }

        /* Error message styles */
        .error-message {
            background: linear-gradient(135deg, #fee, #fdd);
            border: 2px solid #fcc;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        /* Success message for data load */
        .success-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .success-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Success indicator -->
    <div id="successIndicator" class="success-indicator">Data loaded successfully!</div>

    <!-- Header section with corporate branding -->
    <div class="header">
        <h1>Corporate Dashboard</h1>
        <p>Real-time performance and attendance tracking</p>
        <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
    </div>

    <!-- Performance Section -->
    <h2 class="section-header">👥 Supervisor Performance</h2>
    <div id="performanceLoading" class="loading">
        <div class="spinner"></div>
        Loading performance data...
    </div>
    <div id="performanceCards" class="cards-grid performance-grid" style="display: none;"></div>

    <!-- Attendance Section -->
    <h2 class="section-header">📅 Worker Attendance</h2>
    <div id="attendanceLoading" class="loading">
        <div class="spinner"></div>
        Loading attendance data...
    </div>
    <div id="attendanceCards" class="cards-grid attendance-grid" style="display: none;"></div>

    <!-- Overview Section -->
    <h2 class="section-header">📊 Project Overview</h2>
    <div id="overviewLoading" class="loading">
        <div class="spinner"></div>
        Loading overview data...
    </div>
    <div id="overviewCards" class="cards-grid overview-grid" style="display: none;"></div>

    <script>
        // Main initialization function
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // Load all dashboard data
        function loadAllData() {
            loadPerformanceData();
            loadAttendanceData();
            loadOverviewData();
        }

        // Show success indicator
        function showSuccess() {
            const indicator = document.getElementById('successIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // Load performance data from Google Sheets
        function loadPerformanceData() {
            google.script.run
                .withSuccessHandler(displayPerformanceData)
                .withFailureHandler((error) => handleError(error, 'performance'))
                .getPerformanceData();
        }

        // Display performance cards with enhanced styling
        function displayPerformanceData(data) {
            const container = document.getElementById('performanceCards');
            const loading = document.getElementById('performanceLoading');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="error-message">No performance data available</div>';
                return;
            }

            container.innerHTML = data.map(supervisor => `
                <div class="card performance-card">
                    <div class="card-title">${supervisor.supName}</div>
                    <div class="metric">
                        <span class="metric-label">🏗️ Erection:</span>
                        <span class="metric-value">${supervisor.erection.toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">🔧 Dismantling:</span>
                        <span class="metric-value">${supervisor.dismantling.toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">⚖️ Equivalent:</span>
                        <span class="metric-value">${supervisor.equivalent.toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">⏰ Total Manhours:</span>
                        <span class="metric-value">${supervisor.totalManhours.toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">📈 Productivity:</span>
                        <span class="metric-value productivity-value">${supervisor.productivity.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
            
            showSuccess();
        }

        // Load attendance data from Google Sheets
        function loadAttendanceData() {
            google.script.run
                .withSuccessHandler(displayAttendanceData)
                .withFailureHandler((error) => handleError(error, 'attendance'))
                .getAttendanceData();
        }

        // Display attendance calendar cards with enhanced design
        function displayAttendanceData(data) {
            const container = document.getElementById('attendanceCards');
            const loading = document.getElementById('attendanceLoading');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<div class="error-message">No attendance data available</div>';
                return;
            }

            // Group data by worker
            const workerData = {};
            Object.values(data).forEach(record => {
                if (!workerData[record.workerName]) {
                    workerData[record.workerName] = {};
                }
                workerData[record.workerName][record.date] = record;
            });

            container.innerHTML = Object.keys(workerData).map(workerName => {
                const worker = workerData[workerName];
                const dates = Object.keys(worker).sort();
                
                return `
                    <div class="card attendance-card">
                        <div class="card-title">${workerName}</div>
                        <div class="worker-info">
                            <strong>Recent Activity: ${dates.length} days recorded</strong>
                        </div>
                        <div class="attendance-calendar">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => 
                                `<div class="day-header">${day}</div>`
                            ).join('')}
                            ${generateCalendarDays(worker, dates)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate calendar days for attendance with enhanced logic
        function generateCalendarDays(workerData, dates) {
            const days = [];
            const maxDays = 28; // Show 4 weeks
            
            for (let i = 0; i < maxDays; i++) {
                const dateKey = dates[i];
                if (dateKey && workerData[dateKey]) {
                    const record = workerData[dateKey];
                    const hours = parseFloat(record.totalManhours) || 0;
                    const otHours = parseFloat(record.otHours) || 0;
                    
                    let className = 'day-cell ';
                    let content = new Date(dateKey).getDate();
                    let extraContent = '';
                    
                    if (hours === 0) {
                        className += 'absent';
                        content = '✗';
                    } else if (hours > 8 || otHours > 0) {
                        className += 'overtime';
                        extraContent = `<div class="overtime-hours">+${otHours.toFixed(1)}h</div>`;
                    } else {
                        className += 'present';
                        content = '✓';
                    }
                    
                    days.push(`<div class="${className}" title="${dateKey}: ${hours}h total, ${otHours}h OT">${content}${extraContent}</div>`);
                } else {
                    days.push(`<div class="day-cell no-data" title="No data">${i + 1}</div>`);
                }
            }
            
            return days.join('');
        }

        // Load overview data from Google Sheets
        function loadOverviewData() {
            google.script.run
                .withSuccessHandler(displayOverviewData)
                .withFailureHandler((error) => handleError(error, 'overview'))
                .getOverviewData();
        }

        // Display overview cards with enhanced metrics
        function displayOverviewData(data) {
            const container = document.getElementById('overviewCards');
            const loading = document.getElementById('overviewLoading');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="error-message">No overview data available</div>';
                return;
            }

            container.innerHTML = data.map(record => {
                const achievedPercent = parseFloat(record.achievedPercent) || 0;
                let percentClass = 'achievement-low';
                if (achievedPercent >= 90) percentClass = 'achievement-high';
                else if (achievedPercent >= 70) percentClass = 'achievement-medium';
                
                return `
                    <div class="card overview-card">
                        <div class="date-header">📅 ${formatDate(record.date)}</div>
                        <div class="metric">
                            <span class="metric-label">🏗️ Erection:</span>
                            <span class="metric-value">${record.erection.toFixed(1)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">🔧 Dismantling:</span>
                            <span class="metric-value">${record.dismantling.toFixed(1)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">⏰ Total Manhours:</span>
                            <span class="metric-value">${record.totalManhours.toFixed(1)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">🎯 Target:</span>
                            <span class="metric-value">${record.target.toFixed(1)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">✅ Achieved:</span>
                            <span class="metric-value">${record.achieved.toFixed(1)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">📊 Achievement:</span>
                            <span class="achievement-percentage ${percentClass}">${record.achievedPercent.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format date for display with enhanced formatting
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Enhanced error handling with specific section targeting
        function handleError(error, section) {
            console.error(`Error loading ${section} data:`, error);
            
            // Hide specific loading indicator
            const loadingElement = document.getElementById(`${section}Loading`);
            const cardsElement = document.getElementById(`${section}Cards`);
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (cardsElement) {
                cardsElement.style.display = 'block';
                cardsElement.innerHTML = `<div class="error-message">Error loading ${section} data. Please check your internet connection and try refreshing the page.</div>`;
            }
        }

        // Refresh data function with loading states
        function refreshData() {
            // Show loading indicators again
            document.querySelectorAll('.loading').forEach(loading => {
                loading.style.display = 'flex';
            });
            
            document.querySelectorAll('.cards-grid').forEach(grid => {
                grid.style.display = 'none';
            });
            
            // Reload all data
            setTimeout(() => {
                loadAllData();
            }, 500);
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshData, 300000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96ee33d7b65c16dc',t:'MTc1NTE1MDkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
